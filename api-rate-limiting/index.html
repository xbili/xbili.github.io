<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.15.9"/><title data-react-helmet="true">GreatWhale | API Rate Limiting</title><meta data-react-helmet="true" name="description" content="Ramblings of a Software Engineer."/><meta data-react-helmet="true" property="og:title" content="API Rate Limiting"/><meta data-react-helmet="true" property="og:description" content="Ramblings of a Software Engineer."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@xbili"/><meta data-react-helmet="true" name="twitter:title" content="API Rate Limiting"/><meta data-react-helmet="true" name="twitter:description" content="Ramblings of a Software Engineer."/><link rel="shortcut icon" href="/icons/icon-48x48.png?v=a265ecac8acf9e8a22dd5a66089d854c"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#2F6690"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a265ecac8acf9e8a22dd5a66089d854c"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a265ecac8acf9e8a22dd5a66089d854c"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a265ecac8acf9e8a22dd5a66089d854c"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a265ecac8acf9e8a22dd5a66089d854c"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a265ecac8acf9e8a22dd5a66089d854c"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a265ecac8acf9e8a22dd5a66089d854c"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a265ecac8acf9e8a22dd5a66089d854c"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a265ecac8acf9e8a22dd5a66089d854c"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/app-574c37e7a1fc4a15d8d1.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-3637602dec52ad7583c8.js"/><link as="script" rel="preload" href="/commons-7fec34c5275e0db6e149.js"/><link as="script" rel="preload" href="/webpack-runtime-8df5186ebca2376c0adf.js"/><link as="fetch" rel="preload" href="/page-data/api-rate-limiting/page-data.json" crossorigin="anonymous"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="w-full"><header class="w-full bg-blue-900"><div class="container mx-auto px-5 py-5 md:py-12"><div class="flex flex-col"><h1 class="text-4xl md:text-6xl font-black font-header"><a class="text-gray-100 hover:text-gray-400 no-underline" href="/">GreatWhale</a></h1><div><h1 class="font-light text-gray-100">Thoughts by <span class="font-black">Bili Xu</span></h1></div></div></div></header><div class="container mx-auto px-5 mt-5"><main><div><h1 class="font-black font-header text-2xl md:text-4xl text-gray-800 mb-1">API Rate Limiting</h1><p class="text-sm text-gray-600 mb-5">November 26, 2015</p><div class="post-content"><p>Since WordPress&#8217;s new admin site is <strong>so awesome</strong> &lt;insert emoji with heart eyes&gt;, I think I should document my little learning notes here instead. Shall use a sub-domain for this WordPress in time to come!</p>
<p>Letterbox&#8217;s traffic went a bit off today, causing our instance&#8217;s CPU usage to spike. Apparently people were spamming API calls to our server, resulting in some form of DoS attack, well but it didn&#8217;t exactly crash/overload it.</p>
<p>Do things that don&#8217;t scale, right? It probably slipped our mind when designing the API, thinking that all users would be angels and not do weird stuff like that. Clearly we were wrong. Also this would be needed in time to come when the API calls start to exceed Facebook&#8217;s API rate limit.[1]</p>
<p><strong>API Rate Limiting </strong>is basically restricting the number of times a particular end user is able to call the endpoint. There are a couple of ways to do this, and the way that we chose would be to utilize a <strong>Redis cache</strong>.</p>
<p>The idea is to have a key-value pair (user ID as the key and times accessed as value) that will update everytime a call is made, and Redis is perfect for handling little tasks like that.</p>
<p>There&#8217;re many considerations to take into account for such a simple implementation. A <a href="https://www.binpress.com/tutorial/introduction-to-rate-limiting-with-redis/155" target="_blank">cursory look online</a> points to having to deal with HTTP headers (agh damn networking), different time buckets and also pipelining. It is certainly good to dive more into the details in time to come, <strong>but then there&#8217;s finals.</strong></p>
<p>So instead of reinventing the wheel, I opted to use <strong><a href="https://github.com/ded/express-limiter" target="_blank">express-limiter</a>. </strong>It&#8217;s already written and works right out of the npm box. [2] The task is done in around 10 lines of code.</p>
<pre><span class="pl-k">var</span> redisClient <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>redis<span class="pl-pds">'</span></span>).<span class="pl-en">createClient</span>();
<span class="pl-k">var</span> limiter <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>express-limiter<span class="pl-pds">'</span></span>)(app, redisClient);

<span class="pl-en">limiter</span>({
 path<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>/matches<span class="pl-pds">'</span></span>,
 method<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>all<span class="pl-pds">'</span></span>,
 lookup<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>user.id<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>connection.remoteAddress<span class="pl-pds">'</span></span>],
 total<span class="pl-k">:</span> <span class="pl-c1">50</span>,
 expire<span class="pl-k">:</span> <span class="pl-c1">60000</span>
});</pre>
<p>These few lines of code simply set a 50 call limit to /match endpoint, and sends a 429 if there are anymore calls from the same user IP thereafter. It does not seem like much but I think as a frontend developer since forever, I&#8217;ve not been able to appreciate such backend concepts.</p>
<p>A little something I learnt today, besides SQL, DRC/TRC and Relational Algebra. Yup CS2102 is coming up next.</p>
<p>Oh and I realized at the end of writing this post why I wouldn&#8217;t document more craft related post here. <strong>Typing code into WordPress is still pretty painful. </strong></p>
<p>Ciao~</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<hr />
<p>[1] Well&#8230; a problem for next time.<br />
[2] Loses a lot of flexibility though.</p>
<p>&nbsp;</p>
</div></div></main><footer class="flex flex-col items-center text-xs text-gray-600 py-3"><div class="flex mr-3"><a href="https://github.com/xbili" class="flex mx-1 text-blue-800 hover:text-blue-600" target="_blank" rel="noopener noreferrer">GitHub</a><a href="https://www.linkedin.com/in/xbili/" class="flex mx-1 text-blue-800 hover:text-blue-600" target="_blank" rel="noopener noreferrer">LinkedIn</a><a href="https://twitter.com/_xbili" class="flex mx-1 text-blue-800 hover:text-blue-600" target="_blank" rel="noopener noreferrer">Twitter</a></div><p>© <!-- -->2020<!-- -->, Bili Xu</p></footer></div></div></div></div><script>
  
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-102964025-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(!(parseInt(navigator.doNotTrack) === 1 || parseInt(window.doNotTrack) === 1 || parseInt(navigator.msDoNotTrack) === 1 || navigator.doNotTrack === "yes")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-102964025-1', 'xbili.com', {"sampleRate":5,"siteSpeedSampleRate":10});
      ga('set', 'anonymizeIp', true);
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/api-rate-limiting";window.webpackCompilationHash="8f91c9b3bfd2c5f97905";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-574c37e7a1fc4a15d8d1.js"],"component---src-templates-post-js":["/component---src-templates-post-js-3637602dec52ad7583c8.js"],"component---src-pages-404-js":["/component---src-pages-404-js-2afbc856ff6771d98b7b.js"],"component---src-pages-index-js":["/component---src-pages-index-js-732bc6c23769fd96fb97.js"]};/*]]>*/</script><script src="/webpack-runtime-8df5186ebca2376c0adf.js" async=""></script><script src="/commons-7fec34c5275e0db6e149.js" async=""></script><script src="/component---src-templates-post-js-3637602dec52ad7583c8.js" async=""></script><script src="/app-574c37e7a1fc4a15d8d1.js" async=""></script></body></html>